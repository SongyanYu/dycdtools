var.values$dyresmTEMPTURE_Var
?ncdim_def
?ncvar_def
dycd.output="extdata/dysim.nc"
var.extract=c("TEMP")
simData <- nc_open(dycd.output)
simData
varNames <- names(simData$var)
varNames
simData$ndims
simData$filename
simData$id
simData$natts
simData$dim
simData$dim[1]
simData$ndims
simData$dim[2]
# Define an integer dimension
dimState <- ncdim_def( "StateNo", "count", 1:50 )
dimState
# Make an integer variable.  Note that an integer variable can have
# a double precision dimension, or vice versa; there is no fixed
# relationship between the precision of the dimension and that of the
# associated variable.  We just make an integer variable here for
# illustration purposes.
varPop <- ncvar_def("Pop", "count", dimState, -1,
longname="Population", prec="integer")
varPop
# Create a netCDF file with this variable
ncnew <- nc_create( "states_population.nc", varPop )
# Write some values to this variable on disk.
popAlabama <- 4447100
?ncvar_pur
?ncvar_put
ncvar_put( ncnew, varPop, popAlabama, start=1, count=1 )
nc_close(ncnew)
nc_close(simData)
devtools::load_all()
devtools::document()
system.file("extdata", "dysim.nc", package = "dycdtools")
devtools::load_all()
devtools::document()
# check on R-hub
library(rhub)
library(devtools)
devtools::load_all()
devtools::document()
devtools::check_rhub()
devtools::check_rhub()
devtools::spell_check()
devtools::document()
devtools::spell_check()
devtools::release()
library(devtools)
devtools::load_all()
devtools::document()
# check on R-hub
library(rhub)
devtools::check_rhub()
library(usethis)
devtools::load_all()
devtools::document()
devtools::document()
devtools::document()
devtools::check_rhub()
install.packages("roxygen2")
install.packages("roxygen2")
devtools::check_rhub()
devtools::spell_check()
devtools::release()
cal.para<-"../dycdTools pkg and data/Example data/Data/Calibration_parameters.csv"
#---
# 1.combination of parameter values
#---
para.raw<-read.csv(file=cal.para)
View(para.raw)
seq.list<-list()
?seq
cal.para<-"../dycdTools pkg and data/Example data/Data/Calibration_parameters.csv"
#---
# 1.combination of parameter values
#---
para.raw<-read.csv(file=cal.para)
View(para.raw)
seq.list<-list()
for(i in 1:nrow(para.raw)){
seq.list[[i]]<-seq(para.raw$Min[i],para.raw$Max[i],length.out =para.raw$Increment[i])
}
seq.list
if(length(seq.list)==1){
para.df<-data.frame(seq.list[[1]])
}
if(length(seq.list)==2){
para.df<-data.frame(seq.list[[1]],
rep(seq.list[[2]],each=length(seq.list[[1]])))
}
if(length(seq.list)>2){
para.df<-data.frame(seq.list[[1]],
rep(seq.list[[2]],each=length(seq.list[[1]])))
for(i in 3:length(seq.list)){
para.df<-data.frame(para.df,
rep(seq.list[[i]],each=nrow(para.df)))
}
}
View(para.df)
colnames(para.df)<-para.raw$Parameter
View(para.df)
library(usethis)
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
devtools::load_all()
rep(1:3,10)
?rep
rep(1:3,length.out=10)
rep(1:3,10)[1:10]
rep(1:1,10)
sim.cores
?scan
dir.this<-"../../Sim_DYCD/191018-Okaraka_SY/"
log <- list.files(dir.this,pattern = ".log")
log
open(log[1])
log[1]
?list.files
log <- list.files(dir.this,pattern = ".log",full.names = TRUE)
open(log[1])
log[1]
open(log[2])
open(log[1])
while(TRUE){
tmp <- scan(log,1,what="char(0)",sep="\n",quiet=TRUE)
if(length(tmp)==0) {close(log) ; break }
out <- c(out[-1],tmp)
}
?open
log <- file(paste0(dir.this,'/dy.log'))
log
open(log)
out <- scan(log,10,what="char(0)",sep="\n",quiet=TRUE)
out
while(TRUE){
tmp <- scan(log,1,what="char(0)",sep="\n",quiet=TRUE)
if(length(tmp)==0) {close(log) ; break }
out <- c(out[-1],tmp)
}
out
grepl("END: LAKE SIMULATION",out)
devtools::load_all()
devtools::document()
devtools::load_all()
# clean up cluster
try({parallel::stopCluster(cl)})
library(devtools)
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
# clean up cluster
try({parallel::stopCluster(cl)})
#### define function to run (and process?) the model on each core
run.iteration <- function(this.sim, dycd.wd) {
# which core to run it on?
core <- sim.cores[this.sim]
# id folder to use
dir.this <- paste0(dycd.wd,'/core', core)
# copy the parameters files from the base model folder into the iteration's folder
files.params <- list.files(path = dycd.wd,pattern = '.*\\.(par|chm|bio|sed)$',
recursive = FALSE, include.dirs = TRUE, full.names = TRUE)
file.copy(files.params, dir.this, overwrite = TRUE)
### !!!!!!! call code to modify the parameters files as needed here
#---
# change the parameter values in the input files
#---
for(m in 1:ncol(para.df)){
change_input_file(input_file = paste0(dir.this,"/",para.raw$Input_file[m]),
row_no = para.raw$Line_NO[m],
new_value = para.df[this.sim,m])
}
#---
# model simulation / run the .bat file
#---
user.wd <- getwd()
on.exit(setwd(user.wd))
setwd(dir.this)
bat.file <- list.files(pattern = ".bat")
shell(bat.file,intern = TRUE,wait=TRUE)
setwd(user.wd)
## verify that the sim has completed successfully
log <- file(paste0(dir.this,'/dy.log'))
open(log)
out <- scan(log,10,what="char(0)",sep="\n",quiet=TRUE)
while(TRUE){
tmp <- scan(log,1,what="char(0)",sep="\n",quiet=TRUE)
if(length(tmp)==0) {close(log) ; break }
out <- c(out[-1],tmp)
}
if (!TRUE %in% grepl("END: LAKE SIMULATION",out)) {
warning(paste0("Simulation No.",this.sim," did not complete successfully.\n"))
}
# copy the finished nc file for later processing (if needed)
file.copy(from = paste0(dir.this,"/DYsim.nc"),
to = paste0(dir.output,"/DYsim_",this.sim,".nc"))
### ! can also add additional model processing here and write to the output folder,
###   to take advantage of parallel speed if wanted
} # end per core function
library(devtools)
devtools::load_all()
devtools::document()
devtools::document()
devtools::document()
?clusterEvalQ
devtools::document()
# check
devtools::check()
devtools::load_all()
devtools::document()
?copyDirectory
library(dycdtools)
devtools::document()
devtools::document()
devtools::document()
?clusterexport
?clusterEvalQ
library(dycdtools)
devtools::install_github("SongyanYu/dycdtools")
devtools::install_github("SongyanYu/dycdtools")
library(dycdtools)
calib.assist(cal.para = "../R Data/Calibration_parameters.csv",
combination = "all",
model.var = c("TEMP"),
obs.data = "../R Data/Obs_data_template.csv",
objective.function = c("NSE"),
start.date="2002-01-23",
end.date="2016-12-31",
dycd.wd = "../../../Sim_DYCD/191018-Okaraka_SY",
dycd.output = "../../../Sim_DYCD/191018-Okaraka_SY/DYsim.nc",
file_name = "../R output/Calibration.csv",
write.out=TRUE,
parallel=TRUE)
devtools::load_all()
devtools::document()
calib.assist(cal.para = "../R Data/Calibration_parameters.csv",
combination = "random",n=3,
model.var = c("TEMP"),
obs.data = "../R Data/Obs_data_template.csv",
objective.function = c("NSE"),
start.date="2002-01-23",
end.date="2016-12-31",
dycd.wd = "../../../Sim_DYCD/191018-Okaraka_SY",
dycd.output = "../../../Sim_DYCD/191018-Okaraka_SY/DYsim.nc",
file_name = "../R output/Calibration.csv",
write.out=TRUE,
parallel=TRUE)
library(dycdtools)
devtools::install_github("SongyanYu/dycdtools")
devtools::install_github("SongyanYu/dycdtools")
library(dycdtools)
calib.assist(cal.para = "../R Data/Calibration_parameters.csv",
combination = "random",n=3,
model.var = c("TEMP"),
obs.data = "../R Data/Obs_data_template.csv",
objective.function = c("NSE"),
start.date="2002-01-23",
end.date="2016-12-31",
dycd.wd = "../../../Sim_DYCD/191018-Okaraka_SY",
dycd.output = "../../../Sim_DYCD/191018-Okaraka_SY/DYsim.nc",
file_name = "../R output/Calibration.csv",
write.out=TRUE,
parallel=TRUE)
devtools::document()
iteration<-c(2,4,7)
# check on R-hub
library(rhub)
list_validated_emails()
validate_email()
devtools::check_rhub()
devtools::spell_check()
devtools::spell_check()
devtools::spell_check()
devtools::spell_check()
devtools::spell_check()
devtools::load_all()
devtools::document()
# check
devtools::check()
# test
use_testthat()
# check on R-hub
library(rhub)
list_validated_emails()
validate_email()
devtools::check_rhub()
devtools::spell_check()
devtools::release()
check_win_devel()
devtools::check_win_devel()
devtools::check_win_devel()
.Last.error.trace
devtools::check_win_devel()
devtools::release()
devtools::release()
# either install the package from CRAN
install.packages("dycdtools")  # the latest version is 0.3.0
# or from GitHub
devtools::install_github("SongyanYu/dycdtools")
library(dycdtools)
#---
# Read in model calibration outcome
#---
calibration<-read.csv("Calibration.csv")
# DYCD temperature simulations using the optimal set of the three parameters
var.values<-ext.output(dycd.output = "Sim_DYCD/DYsim.nc",
var.extract = c("TEMP"))
plot_prof<-function(sim=temp.interpolated,
obs=obs.temp,
sim.start="2017-06-06",
sim.end="2020-02-29",
plot.start="2017-06-06",
plot.end="2020-02-29",
xlabel="Temperature \u00B0C",
min.depth=0,max.depth,by.value,
plot.save=FALSE,
file_name,
height=11,width=18){
#---
# 1. simulation period
#---
sim.date<-seq.Date(from = as.Date(sim.start,format="%Y-%m-%d"),
to = as.Date(sim.end,format="%Y-%m-%d"),
by="day")
#---
# 2. combine sim with obs by Date and Depth
#---
sim.temp<-as.data.frame(sim)
colnames(sim.temp)<-sim.date
sim.temp$Depth<-seq(min.depth,max.depth,by= by.value)
colnames(obs)<-c("Date","Depth","Value")
obs<-obs%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))
temp.both<-sim.temp%>%
pivot_longer(-Depth,names_to = "Date",values_to = "sim")%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
right_join(.,obs,by=c("Date","Depth"))%>%
filter(Date>=plot.start&Date<=plot.end)
colnames(temp.both)[4]<-"obs"
#---
# 3. profile plot sim vs. obs, faceted by Date
#---
p<-temp.both%>%
ggplot()+
geom_point(aes(y=Depth,x=obs),col="red")+
geom_path(aes(y=Depth,x=sim))+
facet_wrap(~Date)+
ylim(max.depth,min.depth)+
xlab(xlabel)+
ylab("Depth (m)")+
theme_classic()
plot(p)
if(plot.save){
ggsave(filename = file_name,height = height,width = width)
}
}
library(devtools)
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
# check
devtools::check()
# check on R-hub
library(rhub)
devtools::check_rhub()
devtools::check_win_devel()
devtools::check_win_devel()
library(usethis)
library(devtools)
devtools::load_all()
devtools::document()
devtools::check_rhub()
devtools::check_win_devel()
devtools::spell_check()
devtools::release()
# check
devtools::check()
devtools::release()
library(dycdtools)
# DYRESM-CAEDYM modelling outputs are provided in the "Data" folder.
# Extract temperature simulations from the model outputs.
var.values<-ext.output(dycd.output = "Data/DYsim.nc",
var.extract = c("TEMP"))
library(lubridate)
browseVignettes(lubridate)
browseVignettes(package = lubridate)
browseVignettes(package = lubridate)
browseVignettes(package = "lubridate")
package?foo
?filled.contour
?geom_boxplot
?geom_line
?plot.ts
library(dycdtools)
?plot_ts
fun = c('NSE','RMSE')
c('NSE', 'RMSE', 'MAE', 'Pearson', 'RAE') %in% fun
index <- which(c('NSE', 'RMSE', 'MAE', 'Pearson', 'RAE') %in% fun)
index
?list
value.NSE = c(1,2,3,4,5)
value.RMSE = c(10,2,1,5,1)
value.MAE = c(4,6,1,7,3)
value.Pearson = c(4,1,9,7,8)
value.PAE = c(7,9,3,1,5)
value.lst <- list(NSE = value.NSE, RMSE = value.RMSE,
MAE = value.MAE, Pearson = value.Pearson,
PAE = value.PAE)
value.lst
fun
fun <- c('NSE', 'RMSE')
value.lst[fun]
objective_fun<-function(sim,
obs,
fun = c('NSE','RMSE'),
start.date,
end.date,
min.depth,
max.depth,
by.value){
#---
# 1. simulation period
#---
sim.date <- seq.Date(from = as.Date(start.date,format="%Y-%m-%d"),
to = as.Date(end.date,format="%Y-%m-%d"),
by="day")
#---
# 2. combine sim with obs by Date and Depth
#---
sim.var <- as.data.frame(sim)
colnames(sim.var) <- sim.date
sim.var$Depth <- seq(min.depth, max.depth, by = by.value)
var.both <- sim.var %>%
pivot_longer(-Depth, names_to = "Date", values_to = "sim") %>%
mutate(Date = as.Date(Date, format = "%Y-%m-%d")) %>%
right_join(., obs, by = c("Date", "Depth"))
colnames(var.both)[4] <- "obs"
var.both%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))
#---
# 3. calculate goodness of fit measures
#---
value.NSE <- NSE(var.both$sim, obs = var.both$obs)
value.RMSE <- sqrt(mean((var.both$sim-var.both$obs)^2, na.rm = TRUE))
value.MAE <- mean(abs(var.both$sim-var.both$obs), na.rm=TRUE)
value.Pearson <- cor(x = var.both$sim, y = var.both$obs, method = "pearson")
value.PAE <- mean(abs(var.both$sim - var.both$obs), na.rm=TRUE)/mean(abs(var.both$obs-mean(var.both$obs, na.rm = TRUE)), na.rm = TRUE)
value.lst <- list(NSE = value.NSE, RMSE = value.RMSE,
MAE = value.MAE, Pearson = value.Pearson,
PAE = value.PAE)
return(value.lst[fun])
}
?cor
d<- data.frame(a = c(1,2,3,4),
b = c(5,6,3,1))
is.data.frame(d)
library(testthat)
library(dycdtools)
test_check("dycdtools")
context("change input file")
library(dycdtools)
test_that("change input file works", {
fil <- tempfile(fileext = ".data")
cat("TITLE extra line", "2 3 5 7", "", "11 13 17", file = fil,
sep = "\n")
change_input_file(input_file = fil,
row_no = 2,
new_value = 0.9)
read.input<-function(input){
par_data <- readLines(input)
text<-unlist(strsplit(par_data[2], split = " "))[1]
return(text)
}
expect_match(read.input(fil),
"0.9")
})
library(dycdtools)
test_that("change input file works", {
fil <- tempfile(fileext = ".data")
cat("TITLE extra line", "2 3 5 7", "", "11 13 17", file = fil,
sep = "\n")
change_input_file(input_file = fil,
row_no = 2,
new_value = 0.9)
read.input<-function(input){
par_data <- readLines(input)
text<-unlist(strsplit(par_data[2], split = " "))[1]
return(text)
}
expect_match(read.input(fil),
"0.9")
})
devtools::test()
#---
# 1. load all developed functions and internal data (like the "library" function)
#---
devtools::load_all() # the working directory should be in the top level package folder
library(usethis)
create_package(path="dycdtool3")
